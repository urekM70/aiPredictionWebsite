{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Community Page</h2>
    <div class="row">
        <!-- Blog Section -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">Mini Blog</div>
                <div class="card-body">
                    <form id="blogForm">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="blogTitle" placeholder="Title" required>
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="blogContent" rows="3" placeholder="What's on your mind?" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Post</button>
                    </form>
                    <hr>
                    <div id="blogPosts">
                        <!-- Blog posts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">Global Chat</div>
                <div class="card-body">
                    <div id="chatBox" style="height: 300px; overflow-y: scroll; background: #f8f9fa; padding: 10px; border: 1px solid #ddd;"></div>
                    <form id="chatForm" class="mt-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="chatMessage" placeholder="Enter your message..." required>
                            <button class="btn btn-primary" type="submit">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function confirmDeleteChat(id) {
    if (confirm("Do you really want to delete this message?")) {
        const res = await fetch(`/api/chat/delete/${id}`, { method: "POST" });
        if (res.ok) loadChat();
    }
}


    // Blog posting
    document.getElementById("blogForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const title = document.getElementById("blogTitle").value;
        const content = document.getElementById("blogContent").value;
        const res = await fetch("/api/blog/new", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, content })
        });
        if (res.ok) {
            document.getElementById("blogForm").reset();
            loadBlogPosts();
        }
    });
    async function confirmDeleteBlog(id) {
    if (confirm("Do you really want to delete this blog post?")) {
        const res = await fetch(`/api/blog/delete/${id}`, { method: "POST" });
        if (res.ok) loadBlogPosts();
    }
}


    async function loadBlogPosts() {
        const res = await fetch("/api/blog/posts");
        const posts = await res.json();
        const blogContainer = document.getElementById("blogPosts");
blogContainer.innerHTML = posts.map(post => {
    const deletable = (post.username === '{{ session["username"] }}' || '{{ session["username"] }}' === 'admin');
    return `
    <div class="mb-3 border rounded p-2">
        <div class="d-flex justify-content-between">
            <div>
                <h5>${post.title}</h5>
                <small><a href="/profile/${post.username}"><strong>${post.username}</strong></a> | ${new Date(post.timestamp).toLocaleString()}</small>
            </div>
            ${deletable ? `<button onclick="confirmDeleteBlog(${post.id})" class="btn btn-sm text-danger">üóëÔ∏è</button>` : ''}
        </div>
        <p>${post.content}</p>
    </div>`;
}).join("");


    }

    // Chat
    document.getElementById("chatForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const message = document.getElementById("chatMessage").value;
        const res = await fetch("/api/chat/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
        });
        if (res.ok) {
            document.getElementById("chatForm").reset();
            loadChat();
        }
    });

    async function loadChat() {
        const res = await fetch("/api/chat/messages");
        const messages = await res.json();
        const chatBox = document.getElementById("chatBox");
chatBox.innerHTML = messages.map(msg => {
    const deletable = (msg.username === '{{ session["username"] }}' || '{{ session["username"] }}' === 'admin');
    return `
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <a href="/profile/${msg.username}"><strong>${msg.username}</strong></a>: ${msg.message}
        </div>
        ${deletable ? `<button onclick="confirmDeleteChat(${msg.id})" class="btn btn-sm text-danger">üóëÔ∏è</button>` : ''}
    </div>`;
}).join("");



        chatBox.scrollTop = chatBox.scrollHeight;
    }

    setInterval(loadChat, 3000);
    loadChat();
    loadBlogPosts();
</script>
{% endblock %}
